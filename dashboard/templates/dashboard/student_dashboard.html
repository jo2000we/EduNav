{% extends "dashboard/base.html" %}

{% block content %}
<h2 class="text-2xl font-bold mb-4">Hallo {{ student.pseudonym }}</h2>

<div class="mb-6 bg-white p-4 rounded shadow">
  <h3 class="font-semibold mb-2">Gesamtziel</h3>
  <form method="post" action="{% url 'student_overall_goal' %}">
    {% csrf_token %}
    {{ overall_goal_form.overall_goal }}
    <button type="submit" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Speichern</button>
  </form>
</div>

<button data-modal-target="planningModal" data-modal-toggle="planningModal" class="mb-4 bg-green-500 text-white px-4 py-2 rounded">Neuer Tageseintrag</button>

<div class="grid gap-4 md:grid-cols-2">
  {% for entry in entries %}
  <div class="bg-white p-4 rounded shadow">
    <h4 class="font-semibold">{{ entry.session_date }}</h4>
    <div class="mt-2">
      <span class="font-semibold">Ziele:</span>
      <ul class="list-disc list-inside">
        {% for goal in entry.goals.all %}
          <li class="{% if goal.high_priority %}text-red-600 font-bold{% endif %}">{{ goal.text }}</li>
        {% endfor %}
      </ul>
    </div>
    {% if entry.strategies %}<p class="mt-2"><span class="font-semibold">Vorgehen/Strategien:</span> {{ entry.strategies }}</p>{% endif %}
    {% if entry.resources %}<p><span class="font-semibold">Ressourcen:</span> {{ entry.resources }}</p>{% endif %}
    {% if entry.expectations %}<p><span class="font-semibold">Erwartungen:</span> {{ entry.expectations }}</p>{% endif %}

    {% if entry.steps %}
      <hr class="my-2">
      <h5 class="font-semibold">Durchführung</h5>
      <p>{{ entry.steps }}</p>
      {% if entry.strategy_check %}<p><span class="font-semibold">Strategien:</span> {{ entry.strategy_check }}</p>{% endif %}
      {% if entry.problems %}<p><span class="font-semibold">Probleme:</span> {{ entry.problems }}</p>{% endif %}
      {% if entry.emotions_execution %}<p><span class="font-semibold">Emotionen:</span> {{ entry.emotions_execution }}</p>{% endif %}
    {% else %}
      <button data-modal-target="executionModal-{{ entry.id }}" data-modal-toggle="executionModal-{{ entry.id }}" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded">Durchführung eintragen</button>
    {% endif %}

    {% if entry.strategy_evaluation %}
      <hr class="my-2">
      <h5 class="font-semibold">Reflexion</h5>
      {% if entry.strategy_evaluation %}<p><span class="font-semibold">Strategien bewerten:</span> {{ entry.strategy_evaluation }}</p>{% endif %}
      {% if entry.self_assessment %}<p><span class="font-semibold">Selbsteinschätzung:</span> {{ entry.self_assessment }}</p>{% endif %}
      {% if entry.time_management_reflection %}<p><span class="font-semibold">Zeitmanagement:</span> {{ entry.time_management_reflection }}</p>{% endif %}
      {% if entry.emotions_reflection %}<p><span class="font-semibold">Emotionen:</span> {{ entry.emotions_reflection }}</p>{% endif %}
      {% if entry.outlook %}<p><span class="font-semibold">Ausblick:</span> {{ entry.outlook }}</p>{% endif %}
      <div class="mt-2">
        <span class="font-semibold">Zielerreichung:</span>
        <ul class="list-disc list-inside">
          {% for goal in entry.goals.all %}
            <li>{{ goal.text }} - {{ goal.achievement }}{% if goal.comment %} ({{ goal.comment }}){% endif %}</li>
          {% endfor %}
        </ul>
      </div>
    {% elif entry.steps %}
      <button data-modal-target="reflectionModal-{{ entry.id }}" data-modal-toggle="reflectionModal-{{ entry.id }}" class="mt-2 bg-purple-500 text-white px-3 py-1 rounded">Reflexion eintragen</button>
    {% endif %}
  </div>

  <!-- Execution Modal -->
  <div id="executionModal-{{ entry.id }}" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-lg max-h-full">
      <div class="relative bg-white rounded-lg shadow">
        <div class="p-4">
          <h3 class="text-lg font-semibold mb-4">Durchführung</h3>
          <form method="post" action="{% url 'student_entry_execution' entry.id %}" onsubmit="prepareExecution({{ entry.id }})">
            {% csrf_token %}
            {{ execution_form.as_p }}
            <div class="mb-2">
              <span class="font-semibold">Was habe ich konkret gemacht?</span>
              <ul id="exec-goal-list-{{ entry.id }}" class="mt-2"></ul>
              <button type="button" class="mt-2 bg-green-500 text-white px-2 py-1 rounded" onclick="openExecGoalModal({{ entry.id }})">+</button>
            </div>
            <input type="hidden" name="goals_json" id="exec-goals-json-{{ entry.id }}">
            <button type="submit" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Speichern</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Reflection Modal -->
  <div id="reflectionModal-{{ entry.id }}" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-lg max-h-full">
      <div class="relative bg-white rounded-lg shadow">
        <div class="p-4">
          <h3 class="text-lg font-semibold mb-4">Reflexion</h3>
          <form method="post" action="{% url 'student_entry_reflection' entry.id %}" onsubmit="prepareReflection({{ entry.id }})">
            {% csrf_token %}
            {{ reflection_form.as_p }}
            <div class="mb-2">
              <span class="font-semibold">Habe ich meine Ziele erreicht? (vollständig / teilweise / nicht)</span>
              <ul id="refl-goal-list-{{ entry.id }}" class="mt-2"></ul>
            </div>
            <input type="hidden" name="goals_json" id="refl-goals-json-{{ entry.id }}">
            <button type="submit" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Speichern</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Planning Modal -->
<div id="planningModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
  <div class="relative p-4 w-full max-w-lg max-h-full">
    <div class="relative bg-white rounded-lg shadow">
      <div class="p-4">
        <h3 class="text-lg font-semibold mb-4">Tag planen</h3>
        <form method="post" action="{% url 'student_entry_create' %}" onsubmit="preparePlanning()">
          {% csrf_token %}
          <div class="mb-2">
            <label class="font-semibold">Ziele: Was will ich heute / diese Woche erreichen? (fachliche Ziele, Teilaufgaben, persönliche Lernziele)</label>
            <ul id="goal-list" class="mt-2"></ul>
            <button type="button" class="mt-2 bg-green-500 text-white px-2 py-1 rounded" onclick="openGoalModal()">+</button>
          </div>
          <div class="mt-2">{{ planning_form.session_date.label_tag }}{{ planning_form.session_date }}</div>
          <div class="mt-2">{{ planning_form.strategies.label_tag }}{{ planning_form.strategies }}</div>
          <div class="mt-2">{{ planning_form.resources.label_tag }}{{ planning_form.resources }}</div>
          <div class="mt-2">{{ planning_form.expectations.label_tag }}{{ planning_form.expectations }}</div>
          <input type="hidden" name="goals_json" id="goals-json">
          <button type="submit" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Speichern</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Goal modal -->
<div id="goalModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
  <div class="relative p-4 w-full max-w-lg max-h-full">
    <div class="relative bg-white rounded-lg shadow">
      <div class="p-4">
        <h3 class="text-lg font-semibold mb-4">{{ goal_form.text.label }}</h3>
        <form onsubmit="addGoal(event)">
          {{ goal_form.text }}
          <div class="mt-2">
            <label>Geschätzte Zeit (HH:MM)</label>
            <input type="time" id="goal-time" value="00:00" class="block w-full rounded-lg border-gray-300 p-2.5" />
          </div>
          <button type="submit" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Hinzufügen</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
let goals = [];
function openGoalModal(){
  document.getElementById('goalModal').classList.remove('hidden');
}
function addGoal(e){
  e.preventDefault();
  const text = document.querySelector('#goalModal input[name="text"]').value;
  const time = document.getElementById('goal-time').value || "00:00";
  goals.push({text:text, high_priority:false, planned_time:time});
  document.querySelector('#goalModal form').reset();
  document.getElementById('goalModal').classList.add('hidden');
  renderGoals();
}
function renderGoals(){
  const list = document.getElementById('goal-list');
  list.innerHTML='';
  goals.forEach((g,idx)=>{
    const li=document.createElement('li');
    li.className='flex items-center gap-2';
    li.draggable=true;
    li.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',idx);});
    li.addEventListener('dragover',e=>{e.preventDefault();});
    li.addEventListener('drop',e=>{e.preventDefault();const from=e.dataTransfer.getData('text');const to=idx;const moved=goals.splice(from,1)[0];goals.splice(to,0,moved);renderGoals();});
    li.innerHTML=`<span class="flex-1 ${g.high_priority?'text-red-600 font-bold':''}" onclick="togglePriority(${idx})">${g.text}</span><input type="time" value="${g.planned_time}" onchange="updateTime(${idx}, this.value)" class="border rounded p-1"/>`;
    list.appendChild(li);
  });
}
function togglePriority(i){goals[i].high_priority=!goals[i].high_priority;renderGoals();}
function updateTime(i,val){goals[i].planned_time=val;}
function preparePlanning(){document.getElementById('goals-json').value=JSON.stringify(goals.map((g,idx)=>({...g, order:idx})));}

function openExecGoalModal(id){
  const text=prompt('Weitere Tätigkeit');
  if(text){const list=document.getElementById('exec-goal-list-'+id); const li=document.createElement('li'); li.textContent=text; li.dataset.new='true'; li.innerHTML=`<label><input type="checkbox" checked> ${text}</label> <input type="time" value="00:00" class="border rounded p-1">`; list.appendChild(li);}
}
function prepareExecution(id){
  const list=document.querySelectorAll('#exec-goal-list-'+id+' li');
  const data=[]; list.forEach(li=>{const checkbox=li.querySelector('input[type="checkbox"]'); const time=li.querySelector('input[type="time"]').value; const goalId=li.dataset.id; const text=li.dataset.new?li.querySelector('label').innerText.trim():null; data.push({id:goalId, engaged:checkbox.checked, actual_time:time, text:text});});
  document.getElementById('exec-goals-json-'+id).value=JSON.stringify(data);
}

function prepareReflection(id){
  const list=document.querySelectorAll('#refl-goal-list-'+id+' li');
  const data=[]; list.forEach(li=>{const select=li.querySelector('select'); const textarea=li.querySelector('textarea'); data.push({id:li.dataset.id, achievement:select.value, comment:textarea.value});});
  document.getElementById('refl-goals-json-'+id).value=JSON.stringify(data);
}

// populate execution and reflection goal lists for existing entries
{% for entry in entries %}
  document.addEventListener('DOMContentLoaded', function(){
    const execList=document.getElementById('exec-goal-list-{{ entry.id }}');
    const reflList=document.getElementById('refl-goal-list-{{ entry.id }}');
    {% for goal in entry.goals.all %}
      const liE=document.createElement('li');
      liE.dataset.id='{{ goal.id }}';
      liE.innerHTML=`<label><input type="checkbox" ${goal.engaged?'checked':''}> {{ goal.text }}</label> <input type="time" value="{{ goal.planned_time_hhmm }}" class="border rounded p-1">`;
      execList.appendChild(liE);
      const liR=document.createElement('li');
      liR.dataset.id='{{ goal.id }}';
      liR.innerHTML=`{{ goal.text }} <select class="border rounded"><option value="vollständig" {% if goal.achievement=='vollständig' %}selected{% endif %}>vollständig</option><option value="teilweise" {% if goal.achievement=='teilweise' %}selected{% endif %}>teilweise</option><option value="nicht" {% if goal.achievement=='nicht' %}selected{% endif %}>nicht</option></select><textarea class="block w-full border rounded mt-1" rows="2" placeholder="Was hat dazu beigetragen oder mich gehindert?">{{ goal.comment }}</textarea>`;
      reflList.appendChild(liR);
    {% endfor %}
  });
{% endfor %}
</script>
{% endblock %}
