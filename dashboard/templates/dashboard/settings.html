{% extends 'dashboard/base.html' %}
{% block content %}
<h1 class="text-2xl font-bold mb-6">Einstellungen</h1>
<div class="space-y-8">
    <div>
        <h2 class="text-xl font-semibold mb-2">OpenAI API Key</h2>
        <div class="flex items-center">
            <input type="text" id="openai_key" value="{{ settings.openai_api_key }}" class="border p-2 flex-grow" placeholder="OpenAI API Key">
            <span id="api-key-status" class="w-4 h-4 rounded-full ml-2 {% if key_valid %}bg-green-500{% else %}bg-red-500{% endif %}"></span>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const input = document.getElementById('openai_key');
const status = document.getElementById('api-key-status');
let timeout = null;
input.addEventListener('input', function() {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
        fetch("{% url 'update_openai_key' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({openai_api_key: input.value})
        })
        .then(response => response.json())
        .then(data => {
            status.classList.remove('bg-red-500', 'bg-green-500');
            status.classList.add(data.valid ? 'bg-green-500' : 'bg-red-500');
        });
    }, 500);
});
</script>
{% endblock %}
