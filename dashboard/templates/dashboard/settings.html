{% extends 'dashboard/base.html' %}
{% block content %}
<a href="{% url 'classroom_list' %}" class="flex items-center text-blue-500 mb-4">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
    </svg>
    Zur√ºck
</a>
<h1 class="text-2xl font-bold mb-6">Einstellungen</h1>
<div class="space-y-8">
    <div>
        <h2 class="text-xl font-semibold mb-2">OpenAI</h2>
        <div class="flex items-center mb-2 space-x-2">
            <input type="password" id="openai_key" value="{{ settings.openai_api_key }}" class="border p-2 flex-grow" placeholder="OpenAI API Key">
            <button type="button" id="toggle-openai-key" class="px-2 py-1 text-sm border rounded">zeigen</button>
            <span id="api-key-status" class="w-4 h-4 rounded-full {% if key_valid %}bg-green-500{% else %}bg-red-500{% endif %}"></span>
        </div>
        <div class="flex items-center mb-2">
            <input type="text" id="openai_model" value="{{ settings.openai_model }}" class="border p-2 flex-grow" placeholder="OpenAI Model">
        </div>
        <div class="flex items-center">
            <input type="number" step="0.1" min="0" max="2" id="openai_temperature" value="{{ settings.openai_temperature|default:'' }}" class="border p-2 flex-grow" placeholder="Temperatur (0-2)">
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const keyInput = document.getElementById('openai_key');
const modelInput = document.getElementById('openai_model');
const tempInput = document.getElementById('openai_temperature');
const status = document.getElementById('api-key-status');
const toggleBtn = document.getElementById('toggle-openai-key');
let timeout = null;
function sendSettings(){
    fetch("{% url 'update_openai_settings' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
            openai_api_key: keyInput.value,
            openai_model: modelInput.value,
            openai_temperature: tempInput.value
        })
    })
    .then(response => response.json())
    .then(data => {
        status.classList.remove('bg-red-500', 'bg-green-500');
        status.classList.add(data.valid ? 'bg-green-500' : 'bg-red-500');
        if (!data.model_valid) {
            alert('Modell unbekannt, es wird automatisch ein Fallback genutzt');
        }
    });
}
[keyInput, modelInput, tempInput].forEach(el => {
    el.addEventListener('input', function(){
        clearTimeout(timeout);
        timeout = setTimeout(sendSettings, 500);
    });
});

toggleBtn.addEventListener('click', function(){
    if (keyInput.type === 'password') {
        keyInput.type = 'text';
        toggleBtn.textContent = 'verbergen';
    } else {
        keyInput.type = 'password';
        toggleBtn.textContent = 'zeigen';
    }
});
</script>
{% endblock %}
