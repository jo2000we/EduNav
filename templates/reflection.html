{% extends 'base.html' %}
{% block title %}Reflexion{% endblock %}
{% block content %}
<div x-data="reflectionForm()" class="space-y-2">
    <form x-show="!submitted"
          hx-post="/api/reflections/"
          hx-swap="none"
          @htmx:afterRequest="submitted=true; setTimeout(()=>window.location.href='{% url 'dashboard' %}',1500)"
          class="space-y-2">
        <input type="hidden" name="user_session" value="{{ user_session_id }}">
        <input type="hidden" name="goal" value="{{ goal_id }}">
        <div class="space-y-1">
            <p>Hast du dein Ziel erreicht?</p>
            <label class="block"><input type="radio" name="result" value="yes"> Ja</label>
            <label class="block"><input type="radio" name="result" value="partial"> Teilweise</label>
            <label class="block"><input type="radio" name="result" value="no"> Nein</label>
        </div>
        <textarea name="obstacles" class="w-full border p-2" placeholder="Welche Hindernisse gab es?"></textarea>
        <textarea name="next_step" class="w-full border p-2" placeholder="Was ist dein nächster Schritt?"></textarea>
        {% if can_use_ai %}
        <button type="button"
                class="bg-gray-500 text-white px-4 py-2 w-full sm:w-auto"
                hx-post="/api/vg/next-step/suggest/"
                hx-include="closest form"
                hx-swap="none"
                @htmx:afterRequest="handleSuggestions">KI-Vorschläge anzeigen</button>
        <div class="space-y-1" x-show="suggestions.length">
            <template x-for="s in suggestions" :key="s">
                <button type="button" class="border w-full text-left px-2 py-1"
                        hx-post="/api/vg/next-step/suggest/"
                        :hx-vals="{selected: s}"
                        hx-include="closest form"
                        hx-swap="none"
                        @htmx:afterRequest="submitted=true; setTimeout(()=>window.location.href='{% url 'dashboard' %}',1500)"
                        x-text="s"></button>
            </template>
        </div>
        {% endif %}
        <button class="bg-blue-500 text-white px-4 py-2 w-full sm:w-auto">Reflexion speichern</button>
    </form>
    <div x-show="submitted" class="p-4 bg-green-100 rounded">Danke für deine Reflexion!</div>
</div>
<script>
function reflectionForm(){
    return {
        suggestions: [],
        submitted: false,
        handleSuggestions(e){
            let data = {};
            try { data = JSON.parse(e.detail.xhr.responseText); } catch(err){}
            this.suggestions = data.suggestions || [];
        }
    }
}
</script>
{% endblock %}
