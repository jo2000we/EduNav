{% extends 'base.html' %}
{% block title %}Zielsetzung VG{% endblock %}
{% block content %}
<div x-data="goalCoach()" class="grid gap-4 md:gap-6">
    <div id="chat" class="card h-64 overflow-y-auto space-y-2"></div>
    <form :hx-post="goalId ? '/api/vg/coach/next/' : '/api/vg/goals/'" hx-swap="none" @htmx:afterRequest="handleResponse" class="flex flex-col sm:flex-row gap-2">
        {% csrf_token %}
        <input type="hidden" name="user_session" value="{{ user_session_id }}" x-show="!goalId">
        <input type="hidden" name="goal_id" :value="goalId" x-show="goalId">
        <textarea x-model="message" class="flex-1 rounded-xl border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Deine Nachricht..."></textarea>
        <input type="hidden" name="raw_text" :value="message" x-show="!goalId">
        <input type="hidden" name="user_reply" :value="message" x-show="goalId">
        <button class="btn-secondary sm:self-start" type="submit">Senden</button>
    </form>
    <div class="flex flex-wrap gap-2 text-xs">
        <template x-for="(val, key) in smart" :key="key">
            <span class="badge" :class="val ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300' : ''" x-text="key"></span>
        </template>
    </div>
</div>
<script>
function getCookie(name){
    const match = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)'));
    return match ? match[2] : '';
}
function goalCoach(){
    return {
        message:'',
        goalId:null,
        smart:{specific:false, measurable:false, achievable:false, relevant:false, time_bound:false},
        handleResponse(e){
            let data = {};
            try { data = JSON.parse(e.detail.xhr.responseText); } catch(err){}
            if(!this.goalId && data.id){ this.goalId = data.id; }
            if(this.message){ this.addMessage('user', this.message); }
            if(data.assistant_text){ this.addMessage('assistant', data.assistant_text); }
            if(data.smart_status){ this.smart = data.smart_status; }
            this.message='';
            if(data.message_type === 'ready_to_finalize'){
                fetch('/api/vg/goals/finalize/', {
                    method:'POST',
                    headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
                    body:JSON.stringify({goal_id:this.goalId})
                }).then(r=>r.json()).then(res=>{
                    if(res.final_text){ this.addMessage('assistant', res.final_text); }
                    if(res.smart_score){ this.smart = res.smart_score; }
                    window.location.href='/dashboard/';
                });
            }
        },
        addMessage(role,text){
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = role==='assistant'? 'text-blue-700' : 'text-gray-700 text-right';
            div.textContent = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
    }
}
</script>
{% endblock %}
